---
title: Customized Emails
description: "A notebook that will send a customized email using `blastula`"
output:
  html_document:
    toc: yes
    toc_float: yes
editor: visual
editor_options: 
  markdown:
    wrap: 72
    canonical: true
---

## Goals

The goal of this activity is to:

-   Use `blastula` to create a customized email that will replace the
    default email sent by Posit Connect

This will give you the foundation for creating conditional alerting and
reporting methods.

✏️ There will be placeholders (`____`) in the code cells below that you
will need to fill in!

## Activity Notes

Change the current working directory to the
`ds-workflows-r/materials/activities` directory. This keeps the relative
path to the child email document the same between development and
deployment.

```{r change-working-directory, eval=FALSE}

getwd()

setwd("~/ds-workflows-r/materials/activities")

getwd()
```

or set this in the Files pane under "More \> Set As Working Directory"

### Load required packages for summarizing data and creating emails

```{r load-packages}

library(tidyverse)
library(blastula)
library(glue)

```

### Read data from pin

In the previous exercise, we worked with `inspections_filtered` to
create a validated data set called `inspections_validated`. We will now
take this validated data set and use it to send a custom summary email
via Posit Connect. You can use the `inspections_validated` data frame
you generated from the previous exercise if it is still in-memory, or
read this pinned version of the validated project data:

```{r read-data-from-pin}

# Define the virtual corkboard. Do not add any arguments to this code; run as-is.
board <- pins::board_connect()

# Read the existing pin with the data we'll use for this exercise.
inspections_validated <- board |> 
  pins::pin_read("katie.masiello/inspections_validated")

inspections_validated
```

## Task 1 - Compute summary statistics for data

🔄 Task

We'd like to send a custom email that summarizes the validated data. A
lovely feature of `blastula` is that you can use objects from the global
workspace and use them in the email message content. This means
calculations, results, and objects defined in the main report (e.g.,
this file) will be available to use in the email document. So let's
create a few pieces of information in this document that we'll want to
include in the email summary.

-   Create at least three summary statistics for `inspections_validated`
    that would be interesting to report on in your summary email

✅ Solution

```{r summary-statistics}

# create some summary statistics that would be interesting. Number of rows is a great one ;)

num_inspections <- nrow(inspections_validated)

last_30day <- inspections_validated |> 
  filter(inspection_date > (today() - 30)) 

num_last_30day <- nrow(last_30day)

num_fail_last_30day <- last_30day |> filter(results %in% c("FAIL", "PASS W/ CONDITIONS")) |> nrow()

num_pass_last_30day <- last_30day |> filter(results == "PASS") |> nrow()

last_inspection_date <- inspections_validated$inspection_date |> max()
```

## Task 2 - Create an email

🔄 Task

-   Open the file `activity-04_email.Rmd` and write the desired text of
    your email
-   Use some of the summary statistics you calculated above in your
    email

✅ Solution

The essential piece of the blastula email is to define the output type
as `blastula::blastula_email` in the Rmd YAML, e.g.,

```         
---
output: blastula::blastula_email
---
```

You can preview your email as you work with
`blastula::render_connect_email("activity-04_email.Rmd")`

## Task 3 - Render and attach the email

🔄 Task

-   Render the email

-   Attach the email to this report and use a informative subject line
    that includes dynamically calculated summary statistics

✅ Solution

Save the emailed rendering as an object to be attached to this report.

```{r render-and-attach-email}

# create the email object
email <- blastula::render_connect_email("solution-04_email.Rmd")

#  It is in the blastula::attach_connect_email() function that we can specify the email subject line. Maximize the impact of your email by making this informative with dynamic information! You can also add any attachments, like csv files, images, etc.
attach_connect_email(email = email,
                     subject = glue("Inspections Data - {round(num_fail_last_30day/num_last_30day*100,1)}% Fail Rate in last 30 days"))

```

## Bonus - Add informative logs

🔄 Task

Since this will be a scheduled report on Connect, let's add some logging
information so we have a useful historical record, including a capture
of the email that we created.

✅ Solution

We discussed logging in Activity 2 already, but did you know that we can
also have this report include the email output as part of its rendering?
This is great to be able to see what email was generated during the
rendering. Access historical renderings from the [Report History option
in Connect](https://docs.posit.co/connect/user/report-history/).

🧰 Output the html of the rendered email by accessing the `html_html`
attribute of your rendered email object. Set the code chunk option
`results="asis"` to pass the html directly (R Markdown will not try to
process it)

Here's how it's done:

```{r add-logging, results="asis"}

# give a nice timestamp
glue("Report run {blastula::add_readable_time()}")

glue("Here is a preview of the email rendered with this report: ")
email$html_html
```

## Task 4 - Publish to Connect and email yourself the report

🔄 Task

-   Use push-button publishing to publish this document and the
    supporting `activity-04_email.Rmd` file to Connect
-   Configure the Connect settings to send an email after rendering
-   Run the report and check your email!

✅ Solution

For reference, the Connect User Guide provides instructions for
publishing:
<https://docs.posit.co/connect/user/publishing/#publishing-general>
